<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="shortcut icon"
    type="image/jpg"
    href="./assets/images/favicon-16x16.png"
  />
  <title>Snow Planner</title>

  <!-- add fontawesome icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
  />
  <!-- add bluma -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="./assets/css/style.css">
</head>

<body>

  <div id="modal-js-example" class="modal is-active">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <!-- PROFILE MODAL -->

        <!-- MODAL HEADER -->
        <header class="modal-card-head column">
          <p class="modal-card-title">Your Profile</p>
          <!-- <button class="" aria-label="close"></button> -->
        <p class="label mt-2 is-hidden" id="member-created-date">Member Since: January 2012</p>
        </header>
        
        <!-- NAME INPUT -->
        <label class="label">Name</label>
        <div class="field has-addons">
          <div class="control has-icons-left is-expanded">
            <input class="input is-success is-fullwidth" id="name-input" type="text" placeholder="Powder Day" value="">
            <span class="icon is-small is-left">
              <i class="fas fa-user"></i>
            </span>
            <p class="help is-success is-hidden" id="alert-name-valid">Your name was saved successfully.</p>
            <p class="help is-danger is-hidden" id="alert-name-invalid">Your name is blank. Try again!</p>
          </div>
          <div class="control" id="save-name-icon">
            <a class="button is-info name">
              <i class="fas fa-save name-disk name" id="save-disk" style="color: white"></i>
              <i class="fas fa-check name-check is-hidden" id="save-check" style="background-color: white; color: green;"></i>
            </a>
          </div>
        </div>
        
        <!-- EMAIL INPUT-->
        <label class="label">Email</label>
        <div class="field has-addons">
          <div class="control has-icons-left is-expanded">
            <input class="input is-success is-fullwidth" id="email-input" type="text" placeholder="pow@skiallday.com" value="">
            <span class="icon is-small is-left">
              <i class="fas fa-user"></i>
            </span>
            <p class="help is-success is-hidden" id="alert-email-valid">Your email was saved successfully.</p>
            <p class="help is-danger is-hidden" id="alert-email-invalid">The email is invalid. Try again!</p>
          </div>
          <div class="control" id="save-email-icon">
            <a class="button is-info email">
              <i class="fas fa-save email-disk email" id="save-disk" style="color: white"></i>
              <i class="fas fa-check email-check is-hidden" id="save-check" style="background-color: white; color: green;"></i>
            </a>
          </div>
        </div>

        <!-- PASS SELECTION LIST -->
        <label class="label">Your Season Pass</label>
        <div class="field has-addons">
          <div class="control is-expanded">
            <div class="select is-fullwidth" id="pass-input">
              <select name="pass">
                <option value="Epic">EPIC</option>
                <option value="Ikon">Ikon</option>
                <option value="Independent">Independent</option>
              </select>
            </div>
            <p class="help is-danger is-hidden" id="alert-pass-invalid">Please add your name or email.</p>
          </div>
          <!-- <div class="control">
            <button type="submit" class="button is-primary">Choose</button>
          </div> -->
          <div class="control">
            <a class="button is-info pass" id="save-pass-icon">
              <i class="fas fa-save pass-disk pass" id="save-disk" style="color: white"></i>
              <i class="fas fa-check pass-check is-hidden" id="save-check" style="background-color: white; color: green;"></i>
            </a>
          </div>
        </div>

        <!-- PASS LIST -->
        <div class="box" id="pass-selected-container">
          <div class="notification is-primary">
             No Passes Selected
          </div>
        </div>

        <!-- RESORT SELECTION LIST -->
        <label class="label">Your Favorite Resorts</label>
        <div class="field has-addons">
          <div class="control is-expanded">
            <div class="select is-fullwidth" id="resort-input">
              <select name="resort">
                <option value="TBD1">TBD 1</option>
                <option value="TBD2">TBD 2</option>
                <option value="TBD3">TBD 3</option>
              </select>
            </div>
            <p class="help is-danger is-hidden" id="alert-resort-invalid">Please add your name or email.</p>
          </div>
          <div class="control">
            <a class="button is-info resort" id="save-resort-icon">
              <i class="fas fa-save resort-disk" id="save-disk" style="color: white"></i>
              <i class="fas fa-check resort-check is-hidden" id="save-check" style="background-color: white; color: green;"></i>
            </a>
          </div>
        </div>

        <!-- RESORT LIST -->
        <div class="box" id="resort-selected-container">
          <div class="notification is-primary">
             No Resorts Selected
          </div>
        </div>

        <!-- FOOTER DELETE BUTTON -->
        <div class="field is-grouped">
          <div class="control is-expanded">
            <button class="button is-link is-fullwidth" id="delete-profile-button">Delete Profile</button>
          </div>
          <!-- <div class="control">
            <button class="button is-link is-light">Cancel</button>
          </div> -->
        </div>

        <!-- Your content -->
      </div>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
  </div>

  <button class="button js-modal-trigger" data-target="modal-js-example">
    Open JS example modal
  </button>

  <!-- Moment -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

  <script>
    //section:query selector variables go here ðŸ‘‡
    let nameInput = document.getElementById('name-input');
    let emailInput = document.getElementById('email-input');
    let saveNameIcon = document.getElementById('save-name-icon');
    let saveEmailIcon = document.getElementById('save-email-icon');
    let allIconElements = document.querySelectorAll('i');
    let passSelectedContainer = document.getElementById('pass-selected-container');
    let passInput = document.getElementById('pass-input');
    let savePassIcon = document.getElementById('save-pass-icon');
    let resortSelectedContainer = document.getElementById('resort-selected-container');
    let resortInput = document.getElementById('resort-input');
    let saveResortIcon = document.getElementById('save-resort-icon');
    let deleteProfileButton = document.getElementById('delete-profile-button');
    let memberCreatedDate = document.getElementById('member-created-date');
    // emailInput.addEventListener('input', () => console.log('email = ', emailInput.value));
    
    
    //section:global variables go here ðŸ‘‡
    
    //section:event listeners go here ðŸ‘‡
    saveNameIcon.addEventListener('click', () => saveNameEmail(event, "name"));
    saveEmailIcon.addEventListener('click', () => saveNameEmail(event, "email"));
    passSelectedContainer.addEventListener('click', deletePassResort);
    resortSelectedContainer.addEventListener('click', deletePassResort);
    savePassIcon.addEventListener('click', () => savePassInput('pass'));
    saveResortIcon.addEventListener('click', () => savePassInput('resort'));
    deleteProfileButton.addEventListener('click', clearLocalStorage);
    // document.addEventListener('click', (event) => console.log(event.target));
    // nameInput.addEventListener('input', () => console.log('name = ', nameInput.value));

    //section:functions and event handlers go here ðŸ‘‡

    function saveNameEmail(event, field) {
      
      let input = "";
      let validInput = false;
      let mailFormatRegex = /[A-Za-z0-9]+@[a-z]+\.[a-z]{2,3}/g; //email validation
      
      //get input
      field === "email" ? input = emailInput.value : input = nameInput.value;
      
      //validate input
      field === 'email' ? validInput = emailInput.value.match(mailFormatRegex) : validInput = (input && input.trim() !== "");
      
      if (validInput) {
        document.getElementById(`alert-${field}-invalid`).classList.add('is-hidden'); //ensure invalid alert is hidden
        document.getElementById(`alert-${field}-valid`).classList.remove('is-hidden'); //render valid alert
        field === "email" ? emailInput.setAttribute("placeholder", input) : nameInput.setAttribute("placeholder", input); //set placeholder to input value

        //swap disk and check icon to confirm valid
        allIconElements.forEach(element => {
          if (element.classList.contains(`${field}-disk`)) {element.classList.toggle('is-hidden')};
          if (element.classList.contains(`${field}-check`)) {element.classList.toggle('is-hidden')};
        })

        //after 1 second hide check icon, render disk icon, hide alert message
        setTimeout(() => {
          allIconElements.forEach(element => {
          if (element.classList.contains(`${field}-disk`)) {element.classList.toggle('is-hidden')};
          if (element.classList.contains(`${field}-check`)) {element.classList.toggle('is-hidden')};
          document.getElementById(`alert-${field}-valid`).classList.add('is-hidden');
        })
        }, 1000);
        //save to local storage

        
        setLocalStorage(field, input);
        createMemberSinceDate();
        //clear value
        field === "email" ? emailInput.value = "" : nameInput.value = "";

      } else {
        //render invalid alert
        document.getElementById(`alert-${field}-invalid`).classList.remove('is-hidden');
        //focus cursor for input field
        field === "email" ? emailInput.focus() : nameInput.focus();
        //clear value
        field === "email" ? emailInput.value = "" : nameInput.value = "";
        
      }
    }

    function savePassInput(selectedList) {
      let skiProfile = JSON.parse(localStorage.getItem('ski-profile'));

      if (skiProfile) {
        let passSelected = skiProfile ? skiProfile.passes : [];
        let resortSelected = skiProfile ? skiProfile.resorts : [];
  
        let selectOption = document.querySelectorAll('select');
  
        selectOption.forEach(element => {
          if (element.getAttribute('name') === 'pass' && !passSelected.includes(element.value)) {
            console.log(element, element.value, passSelected), 
            passSelected.push(element.value);
            setLocalStorage("passes", passSelected);
          } else if (element.getAttribute('name') === 'resort' && !resortSelected.includes(element.value)) { //must be the resort selected
            console.log(element, element.value, resortSelected), 
            resortSelected.push(element.value);
            setLocalStorage("resorts", resortSelected);
          }
        });
  
        selectedList === "pass" ? passSelectedContainer.textContent = "" : resortSelectedContainer.textContent = "";
        passSelectedContainer.setAttribute("style", "height: 125px; overflow: scroll");
        resortSelectedContainer.setAttribute("style", "height: 125px; overflow: scroll");
  
        selectedList === "pass" ? (
          passSelected.forEach(element => {
            // console.log(passSelected, element);
            let passSelectedElement = document.createElement('div');
            passSelectedElement.classList.add("box", "is-primary", "notification", "passes");
      
            let deleteButton = document.createElement('button');
            deleteButton.classList.add("delete", "is-normal");
      
            passSelectedElement.textContent = element;
      
            passSelectedContainer.append(passSelectedElement);
            passSelectedElement.append(deleteButton);
          })) : (
            resortSelected.forEach(element => {
              // console.log(resortSelected, element);
              let resortSelectedElement = document.createElement('div');
              resortSelectedElement.classList.add("box", "is-primary", "notification", "resorts");
        
              let deleteButton = document.createElement('button');
              deleteButton.classList.add("delete", "is-normal");
        
              resortSelectedElement.textContent = element;
        
              resortSelectedContainer.append(resortSelectedElement);
              resortSelectedElement.append(deleteButton);
            })
          )
          document.getElementById(`alert-${selectedList}-invalid`).classList.add('is-hidden');
        } else {
          console.log('please complete profile');
          document.getElementById(`alert-${selectedList}-invalid`).classList.remove('is-hidden');
          setTimeout(() => {
            document.getElementById(`alert-${selectedList}-invalid`).classList.add('is-hidden');
          }, 3000);
        }
      }

    function createMemberSinceDate() {
      let skiProfile = getLocalStorage();
      console.log(skiProfile);

      if (skiProfile.memberDate === "") {
        let createdDate = moment().format("MMMM D YYYY h:mm:ss a"); //todo:remove day, hours, min, sec
        setLocalStorage("memberDate", createdDate)
        memberCreatedDate.textContent = `Member Since: ${createdDate}`;
        memberCreatedDate.classList.remove('is-hidden');
        console.log(memberCreatedDate.textContent);
        return memberCreatedDate;
      }
    }

    function deletePassResort(event) {
      if (event.target.matches('button')) {
        // console.log(event.target, event.target.parentNode, event.target.parentNode.classList.contains('passes'))
        event.target.parentNode.remove(); //remove resort/pass from DOM
        
        let skiProfile = JSON.parse(localStorage.getItem('ski-profile'));
        let targetList = event.target.parentNode.classList.contains('passes') ? skiProfile.passes : skiProfile.resorts;
        let key = event.target.parentNode.classList.contains('passes') ? "passes" : "resorts";

        console.log(targetList, key)
        let index = targetList.indexOf(
          event.target.parentNode.textContent.trim()
          ); //get index of pass/resort clicked

        targetList.splice(index, 1); //remove pass or resort from local storage
        
        if (targetList.length === 0) {
          let noneSelected = document.createElement('div');
          noneSelected.classList.add("notification", "is-primary");

          event.target.parentNode.classList.contains('passes') ? noneSelected.textContent = "No Passes Selected" : noneSelected.textContent = "No Resorts Selected";
          event.target.parentNode.classList.contains('passes') ? passSelectedContainer.append(noneSelected) : resortSelectedContainer.append(noneSelected);
        }

        setLocalStorage(key, targetList);
      }
    }

    function setLocalStorage(key, value) {
      console.log(key, value);
      let skiProfile = {};

      console.log(JSON.parse(localStorage.getItem("ski-profile")));

      JSON.parse(localStorage.getItem("ski-profile")) ? skiProfile = JSON.parse(localStorage.getItem("ski-profile")) : skiProfile = {name: "", email: "", memberDate: "", passes: [], resorts: [],};

      skiProfile[key] = value;
      console.log(skiProfile);

      localStorage.setItem('ski-profile', JSON.stringify(skiProfile));
    }

    //LOCAL STORAGE FUNCTIONS
    function getLocalStorage() {
      return JSON.parse(localStorage.getItem("ski-profile"));
    }

    // function setLocalStorage(searchHistory) {
      // localStorage.setItem("weatherSearchHistory", JSON.stringify(searchHistory));
    // }

    function clearLocalStorage() {
      console.log('clear')
      localStorage.removeItem("ski-profile"); //clear storage

      //reset name and email
      nameInput.setAttribute('placeholder', "Powder Day");
      emailInput.setAttribute('placeholder', "pow@skiallday.com");

      //reset pass container
      passSelectedContainer.textContent = "";
      let clearPasses = document.createElement('div');
      clearPasses.classList.add("notification", "is-primary");
      clearPasses.textContent = "No Passes Selected";
      passSelectedContainer.append(clearPasses);

      //reset resort container
      resortSelectedContainer.textContent = "";
      let clearResorts = document.createElement('div');
      clearResorts.classList.add("notification", "is-primary");
      clearResorts.textContent = "No Resorts Selected";
      resortSelectedContainer.append(clearResorts);

      //hide member create date
      memberCreatedDate.classList.add('is-hidden');

      nameInput.focus();
    }

    //OPEN AND CLOSE THE PROFILE MODAL
    document.addEventListener('DOMContentLoaded', () => {
      // Functions to open and close a modal
      function openModal($el) {
        $el.classList.add('is-active');
      }

      function closeModal($el) {
        $el.classList.remove('is-active');
      }

      function closeAllModals() {
        (document.querySelectorAll('.modal') || []).forEach(($modal) => {
          closeModal($modal);
        });
      }

      // Add a click event on buttons to open a specific modal
      (document.querySelectorAll('.js-modal-trigger') || []).forEach(($trigger) => {
        const modal = $trigger.dataset.target;
        const $target = document.getElementById(modal);

        $trigger.addEventListener('click', () => {
          openModal($target);
        });
      });

      // Add a click event on various child elements to close the parent modal
      (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
        const $target = $close.closest('.modal');

        $close.addEventListener('click', () => {
          closeModal($target);
        });
      });

      // Add a keyboard event to close all modals
      document.addEventListener('keydown', (event) => {
        const e = event || window.event;

        if (e.keyCode === 27) { // Escape key
          closeAllModals();
        }
      });
    });

  </script>
  
</body>
</html>