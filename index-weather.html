<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <!-- BULMA -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">
  </head>
  <body>

    <div class="container">
      <button id="button" class="button">Button</button>
    </div>

    <div class="columns is-desktop" id=custom-weather-container>
      <!-- timeframe data goes here -->
    </div>

    <!-- Moment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <script src="./assets/js/skiAreas.js"></script>
    <script src="./assets/js/open-weather-data.js"></script>

    <!-- FETCH & RENDER WEATHER DATA -->
    <script>
      //section:query selector variables go here ðŸ‘‡
      let button = document.getElementById('button');

      //section:global variables go here ðŸ‘‡

      //section:event listeners go here ðŸ‘‡
      button.addEventListener('click', handleWeatherbutton);

      //section:functions and event handlers go here ðŸ‘‡

      //CREATE WEATHER CONTAINER
      let weatherContainer = document.getElementById('custom-weather-container');

      function handleWeatherbutton() {
        //GET LATITUDE & LONGITUDE FOR LOCATION EVENT... 
        // let latitude = event.target.getAttribute('data-lat');
        // let longitude = event.target.getAttribute('data-lon');
        // let resortName = event.target.getAttribute('data-resort');

        let latitude = skiAreas[0].Latitude;
        let longitude = skiAreas[0].Longitude;
        let resortName = skiAreas[0].Name; //if necessary

        // let latitude = '39.641667';
        // let longitude = '-105.871667';
        // let resortName = "The Resort"; //if necessary
        
        fetchWeatherData(latitude, longitude, resortName);
      }
      // function fetchWeatherData(latitude, longitude, cityOrZip, cityRendered) {
      function fetchWeatherData(latitude, longitude, resortName) {

        let currentWeatherURL = `https://api.openweathermap.org/data/2.5/onecall?lat=${latitude}&lon=${longitude}&exclude=hourly,minutely,alerts&appid=f0bed1b0eff80d425a392e66c50eb063&units=imperial&units=imperial`;

        // fetch(currentWeatherURL)
        //   .then((response) => {
        //     if (response.ok) {
        //       response.json().then((data) => {
        //         createDailyDataSet(weather, resortName);
        //         createHourlyDataSet(weather, resortName);
        //       });
        //     } else {
        //       validationModal(
        //         "Error: City/Zip Not Found",
        //         `Try Again: ${response.statusText}`
        //       );
        //     }
        //   })
        //   .catch((error) => {
        //     validationModal(
        //       "Error: City/Zip Not Found",
        //       `Try Again: ${response.statusText}`
        //     );
        //   });

        // to test in development use the 2 lines below; to test in production comment outlines below and comment in the fetch above
        // createDailyDataSet(weather, "daily", "Boulder");
        // createHourlyDataSet(weather, "hourly", "Boulder");

        createDailyHourlyWeatherData(weather, "daily", "Boulder");
        createDailyHourlyWeatherData(weather, "hourly", "Boulder");
      }

      function createDailyHourlyWeatherData(weather, timeframe, resortName) {
        let weatherCleanData = [];

        // console.log(weather[timeframe]);

        weather[timeframe].filter((element, index) => {
          let hourOfDay = moment.unix(element.dt).format("H") //24 hour clock

          if (hourOfDay >= 8 && hourOfDay <= 18) { //hour >=8a && <=6p
            weatherCleanData.push({
              type: timeframe,
              date: type = "hourly" ? moment.unix(element.dt).format("M/D/YYYY h:mm a") : moment.unix(element.dt).format("M/D/YYYY"),
              description: element.weather[0].description,
              icon: element.weather[0].icon,
              temp: element.temp.day || element.temp, // element.temp.day is the daily array and element.temp is the hourly array
              windGust: element.wind_gust,
              windSpeed: element.wind_speed,
            });
          }
        })

        console.log(weatherCleanData);

        // timeframe = "hourly" ? renderHourlyWeather(weatherCleanData, resortName) : renderDailyWeather(weatherCleanData, resortName);

        renderDailyWeather(weatherCleanData, resortName);
        // renderHourlyWeather(weatherCleanData, resortName);
        // renderDailyWeather(weatherCleanData, resortName);

      }

      //RENDER WEATHER DATA
      function renderDailyWeather(dailyWeather, resortName) {
        // weatherContainer.textContent = "";

        //CREATE ELEMENTS
        let timeFrameContainer = document.createElement('div');
        let renderResortName = document.createElement('p');
        let weatherTitle = document.createElement('p');

        //CREATE TITLE CONTENT
        renderResortName.textContent = resortName;
        weatherTitle.textContent = "Daily Forecast";
        
        timeFrameContainer.classList.add("column", "is-half", "custom-weather");
        timeFrameContainer.setAttribute("id", "custom-weather");
        timeFrameContainer.setAttribute("style", "background-color: white; border: 1px solid black; height: 500px; overflow: scroll");

        //APPEND TITLE CONTENT
        timeFrameContainer.append(resortName);
        timeFrameContainer.append(weatherTitle);


        weatherTitle.setAttribute("style", "background-color: white; position: sticky; top: 0;");
        
        //CREATE & APPEND WEATHER CONTENT/DATA
        dailyWeather.forEach((element,index) => {
          //CREATE ELEMENTS
          let weatherInfo = document.createElement('p');
          let icon = document.createElement("img");

          weatherInfo.setAttribute("style", "display: flex; align-items: center;");
          
          //CREATE CONTENT
          let date = element.date;
          let temp = Math.round(element.temp);
          icon.setAttribute("src", `https://openweathermap.org/img/w/${element.icon}.png`);

          weatherInfo.textContent = `${date} ${temp}â„‰`;

          //APPEND CONTENT
          weatherContainer.append(timeFrameContainer);
          timeFrameContainer.append(weatherInfo);
          weatherInfo.append(icon);
        })
      }

    </script>

  </body>
</html>